<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.notice.summernote.database.mybatis.mapper.NoticeMapper">
    <!-- FUNCTION :: 게시글 목록 전체 불러오기 -->
    <select id="selectAllNotice" parameterType="NoticeDTO" resultType="NoticeDTO">
        SELECT * FROM notice;
    </select>

    <!-- FUNCTION :: 게시글 등록 -->
    <insert id="insertNotice" parameterType="NoticeDTO">
        INSERT INTO notice(title, content) VALUES(#{title}, #{content});
    </insert>

    <!-- FUNCTION :: 파일 정보 등록 -->
    <insert id="insertFile" parameterType="FileDTO">
        INSERT INTO tfile(ref_name, ref_idx, file_order, path, name, uuid, size, ext)
        VALUES(#{ref_name}, (SELECT idx FROM ${ref_name} ORDER BY idx DESC LIMIT 1), #{file_order}, #{path}, #{name}, #{uuid}, #{size}, #{ext});
    </insert>

    <!-- FUNCTION :: 게시글 수정 -->
    <update id="updateNotice" parameterType="NoticeDTO">
        UPDATE notice SET title = #{title}, content = #{content} WHERE idx = #{idx};
    </update>

    <update id="resetFile" parameterType="FileDTO">
        UPDATE tfile SET name = null, uuid = null, size = 0, ext = null WHERE ref_idx = #{ref_idx} AND ref_name = #{ref_name};
    </update>

    <update id="updateFile" parameterType="FileDTO">
        UPDATE tfile SET name = #{name}, uuid = #{uuid}, size = #{size}, ext = #{ext} WHERE ref_idx = #{ref_idx} AND ref_name = #{ref_name} AND file_order = #{file_order};
    </update>

    <!-- FUNCTION :: 게시글 상세 조회 -->
    <select id="selectNotice" parameterType="NoticeDTO" resultType="NoticeDTO">
        SELECT * FROM notice WHERE idx = #{idx};
    </select>

    <select id="selectFile" parameterType="FileDTO" resultType="FileDTO">
        SELECT * FROM tfile WHERE ref_name = #{ref_name} AND ref_idx = #{ref_idx} ORDER BY file_order ASC;
    </select>

    <!-- FUNCTION :: 게시글 삭제 -->
    <delete id="deleteNotice" parameterType="NoticeDTO">
        DELETE FROM notice WHERE idx = #{idx};
    </delete>

    <delete id="deleteFile" parameterType="FileDTO">
        DELETE FROM tfile WHERE ref_name = #{ref_name} AND ref_idx = #{ref_idx};
    </delete>
</mapper>